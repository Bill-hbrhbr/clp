version: "3"

includes:
  cmake-libs:
    flatten: true
    taskfile: "cmake-libs.yaml"
  misc-libs:
    flatten: true
    taskfile: "misc-libs.yaml"
  utils: "utils.yaml"
  yscope-dev-utils: "../../tools/yscope-dev-utils/exports/taskfiles/utils/utils.yaml"

vars:
  # Checksum paths
  G_DEPS_CPP_CHECKSUMS_DIR: "{{.G_DEPS_CPP_DIR}}/checksums"
  G_DEPS_CPP_CHECKSUM_FILE: "{{.G_DEPS_CPP_CHECKSUMS_DIR}}/all.md5"

  # CMake settings paths
  # NOTE: This must be kept in-sync with its usage in components/core/CMakeLists.txt
  G_DEPS_CPP_CMAKE_SETTINGS_DIR: "{{.G_DEPS_CPP_DIR}}/cmake-settings"

tasks:
  default:
    deps:
      - task: "core"

  core:
    deps:
      - task: ":init"
      - task: "utils:clean-outdated-cpp-checksum-files"
    cmds:
      - task: "yscope-dev-utils:cmake:install-deps-and-generate-settings"
        vars:
          CMAKE_SETTINGS_DIR: "{{.G_DEPS_CPP_CMAKE_SETTINGS_DIR}}"
          CMAKE_SETTINGS_FILE: "{{.G_DEPS_CPP_CMAKE_SETTINGS_DIR}}/all-core.cmake"
          DEP_TASK: "core-all-parallel"
      - task: "utils:combine-cpp-checksum-files"

  core-all-parallel:
    internal: true
    vars:
      CPP_CORE_TASKS:
        - "absl"
        - "antlr-jar"
        - "antlr-runtime"
        - "boost"
        - "catch2"
        - "date"
        - "fmt"
        - "liblzma"
        - "log-surgeon"
        - "lz4"
        - "microsoft.gsl"
        - "mongocxx"
        - "msgpack-cxx"
        - "nlohmann_json"
        - "simdjson"
        - "spdlog"
        - "sqlite3"
        - "utfcpp"
        - "yaml-cpp"
        - "ystdlib"
        - "zlib"
        - "zstd"
    run: "once"
    deps:
      - for:
          var: "CPP_CORE_TASKS"
        task: "{{.ITEM}}"
